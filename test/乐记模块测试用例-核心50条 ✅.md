# 乐记模块核心测试用例（50条）

> 本测试用例聚焦于乐记模块的特有功能，通用功能（如基础CRUD、主题选择等）已在日记模块测试中覆盖，此处仅保留核心通用用例。

---

## 一、乐记序号功能（同一天多篇乐记）

### 1.1 同一天多篇乐记创建

#### P0 TC-001: 同一天创建多篇乐记 - 基本功能  ✅
**测试步骤：**

1. 创建第一篇乐记，日期为今天，内容："今天听的第一首歌"
2. 保存后，再次点击新建
3. 创建第二篇乐记，日期仍为今天，内容："今天听的第二首歌"
4. 保存后查看列表

**预期结果：**
- 两篇乐记都成功创建
- 列表显示：第一篇显示 "#1"，第二篇显示 "#2"
- 两篇乐记的日期相同
- 按创建时间倒序排列（后创建的在前）

#### P0 TC-002: 同一天多篇乐记 - 序号正确性  ✅
**测试步骤：**
1. 在同一天创建3篇乐记
2. 删除中间的一篇（#2）
3. 查看剩余两篇的序号

**预期结果：**
- 删除后，剩余两篇的序号仍为 #1 和 #3（不重新编号）
- 序号基于创建时间排序，不受删除影响

#### P1 TC-003: 同一天多篇乐记 - 不同日期创建后回到同一天  ✅
**测试步骤：**

1. 创建一篇乐记，日期为2024-01-01
2. 创建另一篇乐记，日期为2024-01-02
3. 再创建一篇乐记，日期改回2024-01-01

**预期结果：**
- 2024-01-01的两篇乐记序号分别为 #1 和 #2
- 2024-01-02的乐记序号为 #1
- 序号按同一天内的创建时间排序

#### P1 TC-004: 同一天多篇乐记 - 序号显示格式  ✅
**测试步骤：**

1. 在同一天创建多篇乐记
2. 查看列表中的序号显示

**预期结果：**
- 序号格式为 "#数字"（如 #1, #2, #3）
- 序号显示在日期后面
- 如果只有一篇，也显示 #1

#### P2 TC-005: 同一天多篇乐记 - 创建时间相同的情况
**测试步骤：**
1. 快速连续创建两篇乐记（确保createdAt相同或非常接近）
2. 查看序号

**预期结果：**
- 两篇乐记都有正确的序号（#1, #2）
- 如果createdAt相同，按ID排序确保稳定

---

## 二、乐记与歌词联动功能

### 2.1 歌词快速添加

#### P0 TC-006: 歌词添加到乐记 - 基本功能  ✅
**测试步骤：**
1. 在歌词输入框输入："夜空中最亮的星"
2. 按 Ctrl+Enter 保存歌词
3. 创建一篇新乐记
4. 查看乐记内容

**预期结果：**
- 歌词成功添加到歌词列表
- 歌词和乐记数据独立存储
- 乐记内容不受歌词影响

#### P1 TC-007: 歌词与乐记数据隔离  ✅
**测试步骤：**
1. 添加3条歌词
2. 创建2篇乐记
3. 删除所有歌词
4. 查看乐记列表

**预期结果：**
- 歌词删除后，乐记仍然存在
- 乐记和歌词数据完全独立
- 删除歌词不影响乐记内容

#### P1 TC-008: 歌词编辑不影响乐记  ❌
**测试步骤：**

1. 添加一条歌词："原始歌词"
2. 创建一篇乐记
3. 编辑歌词为："修改后的歌词"
4. 查看乐记内容

**预期结果：**
- 歌词修改成功
- 乐记内容保持不变
- 两者数据互不影响  **歌词编辑的时候列表应该也有滚动的效果**

### 2.2 歌词导入导出与乐记的关系

#### P1 TC-009: 导出乐记数据 - 包含歌词
**测试步骤：**

1. 创建2篇乐记
2. 添加3条歌词
3. 点击"导出所有乐记数据"
4. 查看导出的JSON文件

**预期结果：**
- 导出文件包含乐记和歌词两部分数据
- 数据结构正确：`{ musicEntries: [...], lyrics: [...] }`
- 所有数据完整导出

#### P1 TC-010: 导出乐记数据 - 仅乐记  ✅
**测试步骤：**
1. 创建2篇乐记
2. 不添加任何歌词
3. 点击"导出所有乐记数据"
4. 查看导出的JSON文件

**预期结果：**
- 导出文件包含乐记数据
- lyrics 数组为空或不存在
- 数据结构正确

#### P1 TC-011: 导出乐记数据 - 仅歌词  ✅
**测试步骤：**
1. 不创建任何乐记
2. 添加3条歌词
3. 点击"导出所有乐记数据"
4. 查看导出的JSON文件

**预期结果：**
- 导出文件包含歌词数据
- musicEntries 数组为空或不存在
- 数据结构正确

#### P1 TC-012: 导入乐记数据 - 乐记和歌词同时导入
**测试步骤：**
1. 准备一个包含乐记和歌词的JSON文件
2. 点击"导入所有乐记数据"
3. 选择文件并导入
4. 查看列表

**预期结果：**
- 乐记和歌词都成功导入
- 显示导入统计信息（新增X条乐记，Y条歌词）
- 数据正确显示在列表中

#### P1 TC-013: 导入乐记数据 - 重复数据跳过  ✅
**测试步骤：**
1. 已有2篇乐记和3条歌词
2. 准备一个包含相同ID的乐记和歌词的JSON文件
3. 导入文件

**预期结果：**
- 重复的乐记和歌词被跳过
- 显示跳过数量统计
- 现有数据不受影响

#### P2 TC-014: 导入乐记数据 - 部分数据无效  ✅
**测试步骤：**

1. 准备一个JSON文件，包含：
   - 2条有效的乐记
   - 1条无效的乐记（缺少必要字段）
   - 3条有效的歌词
   - 1条无效的歌词
2. 导入文件

**预期结果：**
- 有效的乐记和歌词成功导入
- 无效的数据被跳过
- 显示详细的错误信息
- 不影响其他有效数据的导入

---

## 三、图片存储与迁移功能

### 3.1 IndexedDB图片存储

#### P0 TC-015: 乐记添加图片 - 保存到IndexedDB  ✅
**测试步骤：**

1. 创建一篇新乐记
2. 添加一张图片
3. 保存乐记
4. 检查localStorage和IndexedDB

**预期结果：**
- 乐记数据保存在localStorage，但image字段为空或undefined
- imageId字段存在，值为乐记ID
- 图片数据保存在IndexedDB中，key为imageId
- 乐记可以正常显示图片

#### P0 TC-016: 乐记加载图片 - 从IndexedDB读取  ✅
**测试步骤：**
1. 创建一篇带图片的乐记并保存
2. 刷新页面
3. 点击该乐记查看

**预期结果：**
- 图片从IndexedDB成功加载
- 图片正常显示在编辑器中
- 图片缓存机制工作正常

#### P1 TC-017: 乐记删除图片 - IndexedDB清理  ✅
**测试步骤：**
1. 创建一篇带图片的乐记并保存
2. 编辑该乐记，删除图片
3. 保存修改
4. 检查IndexedDB

**预期结果：**
- 乐记的imageId字段被删除
- IndexedDB中对应的图片数据被删除
- 编辑器中不再显示图片

#### P1 TC-018: 乐记更新图片 - IndexedDB更新  ✅
**测试步骤：**
1. 创建一篇带图片A的乐记并保存
2. 编辑该乐记，将图片A替换为图片B
3. 保存修改
4. 检查IndexedDB

**预期结果：**
- IndexedDB中旧的图片A被删除
- 新的图片B保存到IndexedDB
- imageId保持不变（仍为乐记ID）
- 编辑器显示新图片B

#### P1 TC-019: 乐记删除 - IndexedDB图片清理  ✅
**测试步骤：**
1. 创建一篇带图片的乐记并保存
2. 记录imageId
3. 删除该乐记
4. 检查IndexedDB

**预期结果：**
- 乐记从列表中删除
- IndexedDB中对应的图片数据被删除
- 不会留下孤立图片数据

### 3.2 图片迁移功能

#### P0 TC-020: 图片迁移 - 从localStorage迁移到IndexedDB
**测试步骤：**
1. 准备一个包含旧格式乐记的localStorage（image字段包含base64）
2. 打开乐记模块
3. 检查是否触发迁移

**预期结果：**
- 检测到需要迁移的图片
- 自动执行迁移流程
- 图片从localStorage迁移到IndexedDB
- 乐记数据更新：image字段删除，imageId字段添加
- 迁移后图片正常显示

#### P1 TC-021: 图片迁移 - 迁移进度提示
**测试步骤：**
1. 准备大量需要迁移的乐记（10篇以上，每篇都有图片）
2. 打开乐记模块
3. 观察迁移过程

**预期结果：**
- 显示迁移进度提示
- 迁移完成后显示成功提示
- 所有图片成功迁移
- 不影响其他功能使用

#### P1 TC-022: 图片迁移 - 迁移失败处理
**测试步骤：**
1. 模拟IndexedDB不可用的情况
2. 尝试打开包含旧格式图片的乐记模块

**预期结果：**
- 检测到迁移失败
- 保留原有image字段（向后兼容）
- 显示错误提示
- 乐记仍可正常显示（使用localStorage中的图片）

#### P2 TC-023: 图片迁移 - 部分迁移失败
**测试步骤：**
1. 准备5篇带图片的乐记
2. 模拟第3篇图片迁移失败
3. 执行迁移

**预期结果：**
- 前2篇图片成功迁移
- 第3篇保留在localStorage
- 后2篇继续迁移
- 显示迁移统计（成功X篇，失败Y篇）

---

## 四、乐记列表显示功能

### 4.1 列表显示与排序  ✅

#### P0 TC-024: 乐记列表 - 序号显示
**测试步骤：**
1. 在不同日期创建多篇乐记
2. 在同一天创建多篇乐记
3. 查看列表显示

**预期结果：**
- 每篇乐记显示正确的序号（#1, #2等）
- 不同日期的乐记序号独立计算
- 序号显示格式统一

#### P0 TC-025: 乐记列表 - 日期分组显示  ✅
**测试步骤：**
1. 在2024-01-01创建2篇乐记
2. 在2024-01-02创建1篇乐记
3. 在2024-01-03创建3篇乐记
4. 查看列表

**预期结果：**
- 乐记按日期分组显示
- 同一天的乐记显示在一起
- 日期格式为 yyyy.mm.dd
- 按日期降序排列（最新的在前）

#### P1 TC-026: 乐记列表 - 图片缩略图显示  ✅
**测试步骤：**
1. 创建3篇乐记：
   - 第1篇：无图片
   - 第2篇：有图片
   - 第3篇：有图片
2. 查看列表

**预期结果：**
- 有图片的乐记显示缩略图
- 无图片的乐记不显示缩略图区域
- 缩略图从IndexedDB正确加载
- 图片缓存机制工作正常

#### P1 TC-027: 乐记列表 - 天气和心情图标显示  ✅
**测试步骤：**
1. 创建多篇乐记，设置不同的天气和心情
2. 查看列表显示

**预期结果：**
- 每篇乐记显示对应的天气图标
- 每篇乐记显示对应的心情图标
- 图标显示正确且清晰

#### P1 TC-028: 乐记列表 - 内容预览  ✅
**测试步骤：**
1. 创建一篇较长的乐记（超过100字）
2. 查看列表中的内容预览

**预期结果：**
- 列表显示内容预览（截取前部分）
- 预览文本正确截取
- 超长内容有省略号或截断处理

### 4.2 列表交互功能

#### P0 TC-029: 乐记列表 - 点击加载  ✅
**测试步骤：**
1. 创建多篇乐记
2. 点击列表中的一篇乐记
3. 查看编辑器

**预期结果：**
- 编辑器加载该乐记的完整内容
- 图片正确加载显示
- 主题、天气、心情等信息正确加载
- 列表项高亮显示（表示当前选中）

#### P1 TC-030: 乐记列表 - 滚动到当前项  ✅  ❌
**测试步骤：**
1. 创建20篇以上的乐记
2. 通过搜索或其他方式选中一篇不在可视区域的乐记
3. 观察列表滚动

**预期结果：**
- 列表自动滚动到选中的乐记
- 滚动动画平滑
- 选中的乐记在可视区域内  **日期从早修改到的时候滚动会有问题，但是这个暂时解决不了**

#### P1 TC-031: 乐记列表 - 删除确认  ✅
**测试步骤：**

1. 创建一篇带图片的乐记
2. 点击删除按钮
3. 确认删除

**预期结果：**
- 显示删除确认对话框
- 确认后乐记被删除
- IndexedDB中的图片也被删除
- 列表更新，显示其他乐记

#### P2 TC-032: 乐记列表 - 导出菜单位置自适应  ✅
**测试步骤：**
1. 创建多篇乐记
2. 点击列表底部的乐记的导出按钮
3. 点击列表顶部的乐记的导出按钮

**预期结果：**
- 底部乐记的导出菜单向上显示
- 顶部乐记的导出菜单向下显示
- 菜单始终在可视区域内
- 菜单位置计算正确

---

## 五、乐记搜索与筛选

### 5.1 搜索功能

#### P0 TC-033: 乐记搜索 - 文本搜索  ✅
**测试步骤：**

1. 创建3篇乐记：
   - 第1篇："今天听了周杰伦的歌"
   - 第2篇："喜欢这首歌的旋律"
   - 第3篇："周杰伦的新专辑很棒"
2. 在搜索框输入"周杰伦"
3. 查看列表

**预期结果：**
- 只显示包含"周杰伦"的乐记（第1篇和第3篇）
- 搜索结果实时更新
- 搜索不区分大小写

#### P1 TC-034: 乐记搜索 - 搜索清空 ✅
**测试步骤：**
1. 执行搜索，显示部分结果
2. 清空搜索框
3. 查看列表

**预期结果：**
- 列表恢复显示所有乐记
- 搜索状态正确重置

#### P1 TC-035: 乐记搜索 - 搜索特殊字符  ✅
**测试步骤：**
1. 创建一篇包含特殊字符的乐记："测试@#$%^&*()"
2. 搜索特殊字符
3. 查看结果

**预期结果：**
- 特殊字符可以正常搜索
- 搜索结果正确
- 不会导致错误

### 5.2 歌词搜索

#### P1 TC-036: 歌词搜索 - 独立搜索  ✅
**测试步骤：**
1. 添加3条歌词
2. 在歌词搜索框输入关键词
3. 查看歌词列表

**预期结果：**
- 只显示匹配的歌词
- 乐记列表不受影响
- 歌词搜索和乐记搜索独立工作

---

## 六、乐记导出功能

### 6.1 单篇乐记导出

#### P0 TC-037: 导出单篇乐记 - TXT格式  ✅
**测试步骤：**
1. 创建一篇乐记，包含：
   - 日期：2024-01-01
   - 内容："今天听了一首好听的歌"
   - 天气：晴天
   - 心情：开心
   - 序号：#1
2. 点击导出按钮，选择TXT格式

**预期结果：**
- 下载TXT文件
- 文件内容包含：日期、序号、天气、心情、内容
- 格式正确，可读性好

#### P1 TC-038: 导出单篇乐记 - Markdown格式  ✅
**测试步骤：**
1. 创建一篇乐记
2. 点击导出按钮，选择Markdown格式

**预期结果：**
- 下载MD文件
- 文件内容为Markdown格式
- 包含标题、元数据、内容等

#### P1 TC-039: 导出单篇乐记 - 带图片的乐记  ✅
**测试步骤：**
1. 创建一篇带图片的乐记
2. 导出为TXT格式

**预期结果：**
- 图片以base64或路径形式包含在文件中
- 或提示图片无法在TXT中显示
- 文本内容完整导出

### 6.2 批量导出

#### P1 TC-040: 导出所有乐记 - JSON格式
**测试步骤：**
1. 创建多篇乐记
2. 添加多条歌词
3. 点击"导出所有乐记数据"

**预期结果：**
- 下载JSON文件
- 文件包含所有乐记和歌词数据
- 数据结构正确
- 图片以imageId形式存储

#### P1 TC-041: 导出所有乐记 - 筛选后导出  ✅
**测试步骤：**
1. 创建5篇乐记
2. 搜索关键词，筛选出2篇
3. 导出所有数据

**预期结果：**
- 导出所有数据（不受搜索筛选影响）
- 或提示是否只导出筛选结果（根据实际实现）

---

## 七、乐记数据完整性

### 7.1 数据一致性

#### P1 TC-042: 乐记保存 - 数据完整性 ✅
**测试步骤：**
1. 创建一篇乐记，设置所有字段：
   - 日期、内容、主题、天气、心情、字体、图片
2. 保存后刷新页面
3. 重新加载该乐记

**预期结果：**
- 所有字段都正确保存
- 图片从IndexedDB正确加载
- 数据完整无丢失

#### P1 TC-043: 乐记编辑 - 部分字段更新 ✅
**测试步骤：**

1. 创建一篇乐记
2. 只修改天气字段
3. 保存

**预期结果：**
- 只有天气字段更新
- 其他字段保持不变
- 数据更新正确

#### P2 TC-044: 乐记数据 - 边界值测试  ✅
**测试步骤：**
1. 创建一篇内容极长的乐记（接近存储限制）
2. 创建一篇只有图片没有文字的乐记
3. 创建一篇只有文字没有图片的乐记

**预期结果：**
- 所有情况都能正常保存
- 数据完整性不受影响
- 加载时数据正确

### 7.2 错误处理

#### P1 TC-045: 乐记保存失败 - 错误处理
**测试步骤：**
1. 模拟localStorage存储失败
2. 尝试保存乐记

**预期结果：**
- 显示错误提示
- 数据不丢失（保留在编辑器中）
- 可以重试保存

#### P2 TC-046: IndexedDB图片加载失败 - 降级处理
**测试步骤：**
1. 创建一篇带图片的乐记并保存
2. 模拟IndexedDB读取失败
3. 尝试加载该乐记

**预期结果：**
- 检测到图片加载失败
- 如果有localStorage备份，使用备份
- 或显示图片加载失败提示
- 文本内容正常显示

---

## 八、乐记特有边界情况

### 8.1 特殊场景

#### P1 TC-047: 同一天创建大量乐记
**测试步骤：**
1. 在同一天快速创建20篇乐记
2. 查看列表和序号

**预期结果：**
- 所有乐记都成功创建
- 序号正确（#1 到 #20）
- 列表显示正常
- 性能不受影响

#### P1 TC-048: 乐记和歌词同时操作
**测试步骤：**
1. 同时进行以下操作：
   - 添加歌词
   - 创建乐记
   - 编辑乐记
   - 删除歌词
2. 观察数据一致性

**预期结果：**
- 所有操作都成功
- 数据不冲突
- 乐记和歌词数据独立
- 无数据丢失或错乱

#### P2 TC-049: 乐记日期切换 - 序号重新计算  ✅
**测试步骤：**
1. 在2024-01-01创建2篇乐记（#1, #2）
2. 在2024-01-02创建1篇乐记（#1）
3. 将2024-01-02的乐记日期改为2024-01-01
4. 查看序号

**预期结果：**
- 修改日期的乐记序号重新计算
- 2024-01-01现在有3篇乐记，序号正确
- 2024-01-02的乐记列表更新

#### P2 TC-050: 乐记模块切换 - 未保存数据保护
**测试步骤：**
1. 创建一篇乐记，输入内容但不保存
2. 切换到其他模块（如日记模块）
3. 观察提示

**预期结果：**
- 检测到未保存的乐记和/或歌词
- 显示确认对话框
- 用户可以选择保存或放弃
- 数据保护机制正常工作

---

## 测试优先级说明

- **P0**: 核心功能，必须测试
- **P1**: 重要功能，建议测试
- **P2**: 边界情况，可选测试

## 测试覆盖范围

本测试用例覆盖：
- ✅ 乐记序号功能（同一天多篇）
- ✅ 乐记与歌词联动
- ✅ 图片存储与迁移（IndexedDB）
- ✅ 乐记列表显示
- ✅ 搜索与筛选
- ✅ 导入导出功能
- ✅ 数据完整性
- ✅ 边界情况处理

## 注意事项

1. 测试前请确保清空localStorage和IndexedDB，避免旧数据干扰
2. 图片迁移测试需要准备旧格式数据
3. 部分测试需要模拟错误情况，可使用浏览器开发者工具
4. 建议按模块顺序测试，先测试基础功能，再测试复杂场景

